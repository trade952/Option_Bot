const WebSocket = require('ws');
const EventEmitter = require('events');

class PocketOptionAPI extends EventEmitter {
  constructor(region = 'UNITED_STATES') {
    super();
    this.wssUrl = 'wss://demo-api-eu.po.market/socket.io/?EIO=4&transport=websocket';
    this.websocket = null;
    this.region = region;
    this.isConnected = false;
  }

  startWebsocket() {
    return new Promise((resolve, reject) => {
      this.websocket = new WebSocket(this.wssUrl);

      this.websocket.on('open', () => {
        console.log('âœ… WebSocket ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿!');
        this.isConnected = true;
        resolve();
      });

      this.websocket.on('message', (data) => {
        this.handleMessage(data);
      });

      this.websocket.on('error', (error) => {
        console.error('âŒ Î£Ï†Î¬Î»Î¼Î± WebSocket:', error);
        reject(error);
      });

      this.websocket.on('close', () => {
        console.log('âŒ Î— ÏƒÏÎ½Î´ÎµÏƒÎ· WebSocket Î­ÎºÎ»ÎµÎ¹ÏƒÎµ.');
        this.isConnected = false;
      });
    });
  }

  handleMessage(data) {
    try {
      const parsedData = JSON.parse(data.substring(2)); // Î‘Ï†Î±Î¯ÏÎµÏƒÎ· Ï„Î¿Ï… Ï€ÏÏÏ„Î¿Ï… "42" Î³Î¹Î± ÏƒÏ‰ÏƒÏ„Î® Î±Ï€Î¿ÏƒÏ„Î¿Î»Î®
      console.log('ğŸ“© Î›Î®ÏˆÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½:', parsedData);
      if (parsedData.name === 'candles') {
        this.emit('candles', parsedData.msg);
      }
    } catch (error) {
      console.error('âŒ Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½:', error);
    }
  }

  getCandles(pair, interval = 'M1', count = 100) {
    const message = {
      name: 'candles',
      msg: {
        pair: pair,
        interval: interval,
        count: count
      }
    };
    this.sendMessage(message);
  }

  buyTrade(pair, direction, amount = 1) {
    const message = {
      name: 'buy',
      msg: {
        pair: pair,
        direction: direction, // "CALL" Î® "PUT"
        amount: amount
      }
    };
    this.sendMessage(message);
  }

  getBalances() {
    const message = {
      name: 'getBalances',
      msg: {}
    };
    this.sendMessage(message);
  }

  sendMessage(message) {
    if (this.isConnected) {
      const data = `42${JSON.stringify(message)}`;
      this.websocket.send(data);
      console.log('ğŸ“¤ Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚:', message);
    } else {
      console.error('âŒ Î— ÏƒÏÎ½Î´ÎµÏƒÎ· WebSocket Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î·.');
    }
  }
}

module.exports = PocketOptionAPI;
